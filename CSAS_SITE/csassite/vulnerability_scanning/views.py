from django.shortcuts import render, redirect
from .models import Target, ScanTask
from .forms import AddForm, AddScanTaskForm
from django.http import HttpResponse, HttpResponseRedirect


# Create your views here.


def home(request):
    return render(request, "vulnerability_scanning/home.html")


def target(request):
    if request.method == 'POST':
        form = AddForm(request.POST)

        if form.is_valid():
            url = form.cleaned_data['url']
            description = form.cleaned_data['description']
            targetlist = Target.targetob.all()
            if 'add' in request.POST:
                for t in targetlist:
                    if url == t.url:
                        return render(request, "vulnerability_scanning/wrong.html")
                tr = Target.targetob.create(url=url, description=description)
                tr.save()
                return HttpResponseRedirect("http://127.0.0.1:8000/vulnerability_scanning/target")
            if 'delete' in request.POST:
                check = request.POST.getlist('choosetarget')
                if check:
                    for c in check:
                        Target.targetob.filter(pk=int(c)).delete()
                    return HttpResponseRedirect("http://127.0.0.1:8000/vulnerability_scanning/target")
                else:
                    return render(request, "vulnerability_scanning/delete2.html")
            targetlist = Target.targetob.all()
        else:
            return HttpResponse("Wrong!")
    else:
        form = AddForm()
        targetlist = Target.targetob.all()
    return render(request, "vulnerability_scanning/target_1.html", {'form': form, 'targetlist': targetlist})


def scan(request):
    scantasklist = ScanTask.scantaskob.all()
    targetlist = Target.targetob.all()
    method_name = "12334"
    if request.method == 'POST':
        form = AddScanTaskForm(request.POST)

        if form.is_valid():
            taskname = form.cleaned_data['taskname']
            target = form.cleaned_data['target']
            method_1 = form.cleaned_data['method_1']
            method_2 = form.cleaned_data['method_2']
            method = 0
            if 'add' in request.POST:
                if method_1 == 1 and method_2 == 1:
                    method = 1
                if method_1 == 1 and method_2 != 1:
                    method = 2
                if method_1 != 1 and method_2 == 1:
                    method = 3
                if method_1 != 1 and method_2 != 1:
                    return render(request, "vulnerability_scanning/wrong.html")
                for s in scantasklist:
                    if target == s.target and method == s.method:
                        return render(request, "vulnerability_scanning/wrong.html")
                scantask = ScanTask.scantaskob.create(taskname=taskname, target=target, method=method)
                scantask.save()
                scantasklist = ScanTask.scantaskob.all()
                return HttpResponseRedirect("http://127.0.0.1:8000/vulnerability_scanning/scan")
            if 'delete' in request.POST:
                check = request.POST.getlist('choosescantask')
                if check:
                    for c in check:
                        ScanTask.scantaskob.filter(pk=int(c)).delete()
                    scantasklist = ScanTask.scantaskob.all()
                    return HttpResponseRedirect("http://127.0.0.1:8000/vulnerability_scanning/scan")
                else:
                    return render(request, "vulnerability_scanning/delete2.html")
            if 'start' in request.POST:
                check = request.POST.getlist('choosescantask')
                if check:
                    HttpResponse("开始扫描！")
                else:
                    HttpResponse("请先选择扫描目标！")
            scantasklist = ScanTask.scantaskob.all()

    else:
        form = AddScanTaskForm()
    return render(request, "vulnerability_scanning/scan.html",
                  {'form': form, 'scantasklist': scantasklist, 'targetlist': targetlist, 'method_name': method_name})


